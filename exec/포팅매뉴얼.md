# PAI (Parent-AI) 서비스 포팅 매뉴얼

## 📋 목차

1. [프로젝트 개요](#1-프로젝트-개요)
2. [개발 환경](#2-개발-환경)
3. [시스템 요구사항](#3-시스템-요구사항)
4. [설치 및 설정](#4-설치-및-설정)
5. [배포 가이드](#5-배포-가이드)
6. [환경 변수 설정](#6-환경-변수-설정)
7. [데이터베이스 설정](#7-데이터베이스-설정)
8. [서비스 실행](#8-서비스-실행)
9. [트러블슈팅](#9-트러블슈팅)
10. [API 문서](#10-api-문서)

---

## 1. 프로젝트 개요

### 1.1 서비스 소개

**PAI (Parent-AI)**는 부모와 자녀 간의 소통을 AI가 도와주는 가족 커뮤니케이션 플랫폼입니다.

### 1.2 주요 기능

- **사용자 관리**: 부모/자녀 프로필 관리, 음성 프로필 등록
- **대화 시스템**: 실시간 채팅, 이미지 기반 대화, AI 답변 생성
- **퀴즈 시스템**: 부모가 퀴즈 생성, 자녀가 풀이, 보상 시스템
- **분석 기능**: 관심사 분석, 대화 통계, 데이터 시각화
- **TTS**: AI 답변의 음성 변환

### 1.3 아키텍처

- **Frontend**: React Native (Expo)
- **Backend**: NestJS 마이크로서비스
- **AI Service**: Python FastAPI
- **Database**: PostgreSQL + Redis
- **Infrastructure**: Docker + Traefik + gitlab ci

---

## 2. 개발 환경

### 2.1 Frontend (React Native)

```bash
Node.js: 18.x 이상
npm: 9.x 이상
Expo CLI: 6.x 이상
React Native: 0.73.x
TypeScript: 5.x
```

### 2.2 Backend (NestJS)

```bash
Node.js: 18.x 이상
NestJS: 10.x
TypeScript: 5.x
npm: 9.x 이상
```

### 2.3 AI Service (Python)

```bash
Python: 3.9 이상
FastAPI: 0.104.x
PyTorch: 2.x
Transformers: 4.x
```

### 2.4 Infrastructure

```bash
Docker: 24.x 이상
Docker Compose: 2.x 이상
PostgreSQL: 15.x
Redis: 7.x
Traefik: 3.1.x
```

---

## 3. 시스템 요구사항

### 3.1 서버 사양 (최소)

- **CPU**: 4 Core 이상
- **RAM**: 8GB 이상
- **Storage**: SSD 100GB 이상
- **Network**: 1Gbps 이상

### 3.2 서버 사양 (권장)

- **CPU**: 8 Core 이상
- **RAM**: 16GB 이상
- **Storage**: SSD 200GB 이상
- **Network**: 1Gbps 이상

### 3.3 운영체제

- Ubuntu 20.04 LTS 이상
- CentOS 8 이상
- Docker 지원 Linux 배포판

---

## 4. 설치 및 설정

### 4.1 프로젝트 클론

```bash
git clone https://github.com/your-org/PAI-S13P21C101.git
cd PAI-S13P21C101
```

### 4.2 Docker 설치

```bash
# Docker 설치 (Ubuntu)
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Docker Compose 설치
sudo curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Docker 서비스 시작
sudo systemctl start docker
sudo systemctl enable docker
```

### 4.3 Node.js 설치 (개발 환경)

```bash
# Node.js 18.x 설치
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 버전 확인
node --version
npm --version
```

### 4.4 Python 설치 (AI 서비스 개발용)

```bash
# Python 3.9 설치
sudo apt update
sudo apt install python3.9 python3.9-pip python3.9-venv

# Python 버전 확인
python3.9 --version
```

---

## 5. 배포 가이드

### 5.1 환경 파일 설정

각 서비스별로 환경 파일을 설정해야 합니다.

#### 5.1.1 Gateway 환경 설정

```bash
# BE/apps/gateway/.env
PORT=3006
JWT_SECRET=your-jwt-secret-key
JWT_EXPIRES_IN=1h
REFRESH_TOKEN_EXPIRES_IN=7d

# 마이크로서비스 URL
USER_SERVICE_URL=http://user-service:3001
MEDIA_SERVICE_URL=http://media-service:3002
ARK_SERVICE_URL=http://ark-service:3003
CONVERSATION_SERVICE_URL=http://conversation-service:3004
QUIZ_SERVICE_URL=http://quiz-service:3005
AI_SERVICE_URL=http://ai-service:8000

# Redis 설정
REDIS_HOST=redis
REDIS_PORT=6379
```

#### 5.1.2 User Service 환경 설정

```bash
# BE/apps/user-service/.env
PORT=3001
DATABASE_HOST=postgres
DATABASE_PORT=5432
DATABASE_NAME=pai_db
DATABASE_USER=pai_user
DATABASE_PASSWORD=pai_pass

JWT_SECRET=your-jwt-secret-key
BCRYPT_ROUNDS=12

REDIS_HOST=redis
REDIS_PORT=6379
```

#### 5.1.3 Media Service 환경 설정

```bash
# BE/apps/media-service/.env
PORT=3002
DATABASE_HOST=postgres
DATABASE_PORT=5432
DATABASE_NAME=pai_db
DATABASE_USER=pai_user
DATABASE_PASSWORD=pai_pass

# 파일 업로드 설정
UPLOAD_PATH=/app/uploads
MAX_FILE_SIZE=10485760  # 10MB
ALLOWED_MIME_TYPES=image/jpeg,image/png,audio/wav,audio/mp3
```

#### 5.1.4 AI Service 환경 설정

```bash
# AI_integration/.env
PORT=8000
CORS_ORIGINS=*
DEBUG=false

# TTS 모델 설정
TTS_MODEL_PATH=/app/models/tts
TTS_DEVICE=cpu

# VQA 모델 설정
VQA_MODEL_PATH=/app/models/vqa
VQA_DEVICE=cpu
```

### 5.2 SSL 인증서 설정

```bash
# Let's Encrypt 디렉터리 생성
mkdir -p BE/letsencrypt
chmod 600 BE/letsencrypt

# 도메인 변경 (docker-compose.yml에서)
# j13c101.p.ssafy.io를 실제 도메인으로 변경
```

### 5.3 Docker 이미지 빌드 및 배포

```bash
# 백엔드 서비스 빌드 및 배포
cd BE

# 각 서비스별 Docker 이미지 빌드
docker build -t your-registry/gateway:latest apps/gateway/
docker build -t your-registry/user-service:latest apps/user-service/
docker build -t your-registry/media-service:latest apps/media-service/
docker build -t your-registry/ark-service:latest apps/ark-service/
docker build -t your-registry/conversation-service:latest apps/conversation-service/
docker build -t your-registry/quiz-service:latest apps/quiz-service/

# AI 서비스 빌드
cd ../AI_integration
docker build -t your-registry/ai-service:latest .

# Docker Registry에 푸시
docker push your-registry/gateway:latest
docker push your-registry/user-service:latest
docker push your-registry/media-service:latest
docker push your-registry/ark-service:latest
docker push your-registry/conversation-service:latest
docker push your-registry/quiz-service:latest
docker push your-registry/ai-service:latest
```

### 5.4 서비스 실행

```bash
cd BE

# 환경 변수 설정
export GATEWAY_PORT=3006

# Docker Compose로 전체 서비스 실행
docker-compose up -d

# 서비스 상태 확인
docker-compose ps
docker-compose logs -f
```

---

## 6. 환경 변수 설정

### 6.1 공통 환경 변수

```bash
# 데이터베이스 설정
DATABASE_HOST=postgres
DATABASE_PORT=5432
DATABASE_NAME=pai_db
DATABASE_USER=pai_user
DATABASE_PASSWORD=your-secure-password

# Redis 설정
REDIS_HOST=redis
REDIS_PORT=6379

# JWT 설정
JWT_SECRET=your-super-secret-jwt-key-min-32-chars
JWT_EXPIRES_IN=1h
REFRESH_TOKEN_EXPIRES_IN=7d

# 암호화 설정
BCRYPT_ROUNDS=12
```

### 6.2 서비스별 포트 설정

```bash
GATEWAY_PORT=3006
USER_SERVICE_PORT=3001
MEDIA_SERVICE_PORT=3002
ARK_SERVICE_PORT=3003
CONVERSATION_SERVICE_PORT=3004
QUIZ_SERVICE_PORT=3005
AI_SERVICE_PORT=8000
```

### 6.3 보안 설정

```bash
# CORS 설정
CORS_ORIGINS=https://your-domain.com

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000  # 15분
RATE_LIMIT_MAX_REQUESTS=100

# 파일 업로드 제한
MAX_FILE_SIZE=10485760  # 10MB
UPLOAD_PATH=/app/uploads
```

---

## 7. 데이터베이스 설정

### 7.1 PostgreSQL 초기 설정

```sql
-- 데이터베이스 생성
CREATE DATABASE pai_db;
CREATE USER pai_user WITH PASSWORD 'pai_pass';
GRANT ALL PRIVILEGES ON DATABASE pai_db TO pai_user;

-- 확장 기능 설치
\c pai_db;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
```

### 7.2 테이블 스키마

데이터베이스 스키마는 각 서비스가 시작될 때 자동으로 생성됩니다.

### 7.3 초기 데이터 삽입

```sql
-- 관리자 계정 생성 (선택사항)
INSERT INTO users (user_id, email, password_hash, name, created_at)
VALUES (
  uuid_generate_v4(),
  'admin@pai.com',
  '$2b$12$encrypted_password_hash',
  'Administrator',
  NOW()
);
```

---

## 8. 서비스 실행

### 8.1 개발 환경 실행

```bash
# 백엔드 서비스 개발 모드 실행
cd BE
npm install
npm run start:dev

# 프론트엔드 개발 모드 실행
cd FE
npm install
npx expo start
```

### 8.2 프로덕션 환경 실행

```bash
# Docker Compose로 전체 서비스 실행
cd BE
docker-compose up -d

# 서비스 상태 모니터링
docker-compose logs -f
docker stats
```

### 8.3 개별 서비스 재시작

```bash
# 특정 서비스만 재시작
docker-compose restart gateway
docker-compose restart user-service
docker-compose restart ai-service
```

### 8.4 서비스 중지

```bash
# 전체 서비스 중지
docker-compose down

# 볼륨까지 삭제 (주의!)
docker-compose down -v
```

---

## 9. 트러블슈팅

### 9.1 일반적인 문제

#### 9.1.1 서비스 연결 실패

```bash
# 네트워크 상태 확인
docker network ls
docker network inspect pai

# 서비스 로그 확인
docker-compose logs service-name

# 포트 확인
netstat -tlnp | grep :3006
```

#### 9.1.2 데이터베이스 연결 실패

```bash
# PostgreSQL 컨테이너 상태 확인
docker-compose logs postgres

# 데이터베이스 연결 테스트
docker exec -it postgres psql -U pai_user -d pai_db

# 데이터베이스 재시작
docker-compose restart postgres
```

#### 9.1.3 Redis 연결 실패

```bash
# Redis 컨테이너 상태 확인
docker-compose logs redis

# Redis 연결 테스트
docker exec -it redis redis-cli ping

# Redis 재시작
docker-compose restart redis
```

### 9.2 성능 문제

#### 9.2.1 메모리 부족

```bash
# 메모리 사용량 확인
docker stats

# 메모리 제한 설정 (docker-compose.yml)
services:
  service-name:
    mem_limit: 1g
    memswap_limit: 1g
```

#### 9.2.2 디스크 공간 부족

```bash
# 디스크 사용량 확인
df -h

# Docker 정리
docker system prune -a
docker volume prune
```

### 9.3 SSL/TLS 문제

#### 9.3.1 Let's Encrypt 인증서 갱신

```bash
# 인증서 수동 갱신
docker-compose exec traefik traefik update

# 인증서 상태 확인
openssl s_client -connect your-domain.com:443 -servername your-domain.com
```

---

## 10. API 문서

### 10.1 API 엔드포인트

#### 10.1.1 인증 관련

```
POST /api/auth/login          # 로그인
POST /api/auth/signup         # 회원가입
POST /api/auth/refresh        # 토큰 갱신
POST /api/auth/logout         # 로그아웃
```

#### 10.1.2 사용자 관리

```
GET    /api/users/profile     # 프로필 조회
PUT    /api/users/profile     # 프로필 수정
POST   /api/profiles          # 프로필 생성
GET    /api/profiles          # 프로필 목록
POST   /api/profiles/select   # 프로필 선택
```

#### 10.1.3 대화 관리

```
GET    /api/conversations     # 대화 목록
POST   /api/conversations     # 대화 생성
GET    /api/conversations/:id # 대화 상세
POST   /api/conversations/:id/messages # 메시지 전송
```

#### 10.1.4 퀴즈 관리

```
GET    /api/quiz/available    # 이용 가능한 퀴즈
POST   /api/quiz             # 퀴즈 생성
POST   /api/quiz/:id/submit  # 퀴즈 제출
GET    /api/quiz/children/completed # 자녀 퀴즈 결과
```

#### 10.1.5 AI 서비스

```
POST   /tts/generate          # TTS 생성
POST   /vqa/question          # VQA 질문
```

### 10.2 Swagger 문서

각 서비스는 Swagger UI를 제공합니다:

- Gateway: `https://your-domain.com/api/docs`
- User Service: `http://localhost:3001/docs`
- Quiz Service: `http://localhost:3005/docs`

---

## 11. 모니터링 및 로깅

### 11.1 로그 수집

```bash
# 전체 서비스 로그
docker-compose logs -f

# 특정 서비스 로그
docker-compose logs -f gateway

# 로그 파일로 저장
docker-compose logs > service.log
```

### 11.2 헬스 체크

```bash
# 서비스 상태 확인
curl https://your-domain.com/api/health

# 개별 서비스 헬스 체크
curl http://localhost:3001/health  # User Service
curl http://localhost:3002/health  # Media Service
```

### 11.3 성능 모니터링

```bash
# 리소스 사용량 모니터링
docker stats

# 시스템 리소스 확인
top
htop
iotop
```

---

## 12. 백업 및 복구

### 12.1 데이터베이스 백업

```bash
# PostgreSQL 백업
docker exec postgres pg_dump -U pai_user pai_db > backup_$(date +%Y%m%d).sql

# 자동 백업 스크립트
#!/bin/bash
BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)
docker exec postgres pg_dump -U pai_user pai_db > $BACKUP_DIR/pai_db_$DATE.sql
```

### 12.2 데이터베이스 복구

```bash
# PostgreSQL 복구
docker exec -i postgres psql -U pai_user pai_db < backup_20240101.sql
```

### 12.3 파일 백업

```bash
# 미디어 파일 백업
tar -czf media_backup_$(date +%Y%m%d).tar.gz /app/uploads/

# 설정 파일 백업
tar -czf config_backup_$(date +%Y%m%d).tar.gz BE/apps/*/env
```

---

## 📞 지원 및 문의

### 개발팀 연락처

- **이메일**: dev@pai.com
- **Slack**: #pai-support
- **GitHub Issues**: https://github.com/your-org/PAI/issues

### 긴급 연락처

- **서버 장애**: +82-10-xxxx-xxxx
- **보안 문제**: security@pai.com

---

## 📝 라이센스

이 프로젝트는 MIT 라이센스 하에 배포됩니다.

---

## 🔄 버전 히스토리

- **v1.0.0** (2024-01-XX): 초기 릴리즈
- **v1.1.0** (2024-XX-XX): 기능 추가 및 버그 수정

---

_이 문서는 PAI 서비스의 포팅과 배포를 위한 완전한 가이드입니다. 추가 질문이나 문제가 있으시면 개발팀에 문의해주세요._
