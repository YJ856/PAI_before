# PAI 서비스 빠른 배포 가이드

## 🚀 빠른 시작 (Quick Start)

### 1️⃣ 사전 요구사항
```bash
# 필수 설치 항목
- Docker 24.x 이상
- Docker Compose 2.x 이상
- Git
- 최소 8GB RAM, 4 Core CPU
```

### 2️⃣ 저장소 클론
```bash
git clone <repository-url>
cd PAI-S13P21C101
```

### 3️⃣ 환경 변수 설정
```bash
# 환경 파일 복사 및 수정
cp BE/apps/gateway/.env.example BE/apps/gateway/.env
cp BE/apps/user-service/.env.example BE/apps/user-service/.env
cp BE/apps/media-service/.env.example BE/apps/media-service/.env
cp BE/apps/ark-service/.env.example BE/apps/ark-service/.env
cp BE/apps/conversation-service/.env.example BE/apps/conversation-service/.env
cp BE/apps/quiz-service/.env.example BE/apps/quiz-service/.env
cp AI_integration/.env.example AI_integration/.env
```

### 4️⃣ 서비스 실행
```bash
cd BE

# 백그라운드에서 전체 서비스 시작
docker-compose up -d

# 로그 확인
docker-compose logs -f
```

### 5️⃣ 상태 확인
```bash
# 서비스 상태 확인
docker-compose ps

# 헬스 체크
curl http://localhost:3006/health
```

---

## 🏗️ 서비스 구성

### 🌐 접근 URL
- **Local**: http://localhost:3006
- **Production**: https://j13c101.p.ssafy.io

### 📊 서비스 포트
| 서비스 | 내부 포트 | 설명 |
|--------|-----------|------|
| Gateway | 3006 | API 게이트웨이 |
| User Service | 3001 | 사용자 관리 |
| Media Service | 3002 | 파일 관리 |
| ARK Service | 3003 | 관심사 분석 |
| Conversation Service | 3004 | 대화 관리 |
| Quiz Service | 3005 | 퀴즈 관리 |
| AI Service | 8000 | AI 기능 |
| PostgreSQL | 5432 | 메인 데이터베이스 |
| Redis | 6379 | 캐시/세션 |

---

## ⚙️ 환경 변수 설정 예시

### Gateway (.env)
```bash
PORT=3006
JWT_SECRET=your-super-secret-jwt-key-minimum-32-characters
JWT_EXPIRES_IN=1h
REFRESH_TOKEN_EXPIRES_IN=7d

USER_SERVICE_URL=http://user-service:3001
MEDIA_SERVICE_URL=http://media-service:3002
ARK_SERVICE_URL=http://ark-service:3003
CONVERSATION_SERVICE_URL=http://conversation-service:3004
QUIZ_SERVICE_URL=http://quiz-service:3005
AI_SERVICE_URL=http://ai-service:8000

REDIS_HOST=redis
REDIS_PORT=6379
```

### User Service (.env)
```bash
PORT=3001
DATABASE_HOST=postgres
DATABASE_PORT=5432
DATABASE_NAME=pai_db
DATABASE_USER=pai_user
DATABASE_PASSWORD=your-secure-password

JWT_SECRET=your-super-secret-jwt-key-minimum-32-characters
BCRYPT_ROUNDS=12

REDIS_HOST=redis
REDIS_PORT=6379
```

### AI Service (.env)
```bash
PORT=8000
CORS_ORIGINS=*
DEBUG=false

TTS_MODEL_PATH=/app/models/tts
TTS_DEVICE=cpu
VQA_MODEL_PATH=/app/models/vqa
VQA_DEVICE=cpu
```

---

## 🔧 개발 환경 설정

### Backend 개발 서버
```bash
cd BE
npm install

# 개별 서비스 실행
npm run start:dev gateway
npm run start:dev user-service
npm run start:dev conversation-service
```

### Frontend 개발 서버
```bash
cd FE
npm install

# Expo 개발 서버 시작
npx expo start

# iOS 시뮬레이터
npx expo start --ios

# Android 에뮬레이터
npx expo start --android
```

---

## 🔍 모니터링 및 로그

### 로그 확인
```bash
# 전체 서비스 로그
docker-compose logs -f

# 특정 서비스 로그
docker-compose logs -f gateway
docker-compose logs -f user-service

# 실시간 로그 (최근 100줄)
docker-compose logs -f --tail=100
```

### 상태 모니터링
```bash
# 컨테이너 상태
docker-compose ps

# 리소스 사용량
docker stats

# 서비스 헬스 체크
curl http://localhost:3006/api/health
curl http://localhost:3001/health
curl http://localhost:8000/health
```

---

## 🗄️ 데이터베이스 관리

### PostgreSQL 접속
```bash
# 데이터베이스 접속
docker exec -it postgres psql -U pai_user -d pai_db

# 테이블 확인
\dt

# 사용자 목록 확인
SELECT * FROM users LIMIT 5;
```

### Redis 접속
```bash
# Redis 접속
docker exec -it redis redis-cli

# 키 목록 확인
KEYS *

# 연결 테스트
PING
```

### 데이터베이스 백업
```bash
# PostgreSQL 백업
docker exec postgres pg_dump -U pai_user pai_db > backup_$(date +%Y%m%d).sql

# Redis 백업
docker exec redis redis-cli SAVE
docker cp redis:/data/dump.rdb ./redis_backup_$(date +%Y%m%d).rdb
```

---

## 🔄 서비스 관리

### 서비스 재시작
```bash
# 전체 서비스 재시작
docker-compose restart

# 특정 서비스만 재시작
docker-compose restart gateway
docker-compose restart user-service
```

### 서비스 스케일링
```bash
# 특정 서비스 인스턴스 증가
docker-compose up -d --scale user-service=3
docker-compose up -d --scale conversation-service=2
```

### 서비스 중지 및 정리
```bash
# 서비스 중지
docker-compose stop

# 서비스 중지 및 컨테이너 제거
docker-compose down

# 볼륨까지 제거 (데이터 삭제 주의!)
docker-compose down -v

# 이미지까지 정리
docker-compose down --rmi all
```

---

## 🚨 문제 해결

### 일반적인 문제

#### 포트 충돌
```bash
# 포트 사용 확인
netstat -tlnp | grep :3006
lsof -i :3006

# 프로세스 종료
kill -9 <PID>
```

#### 메모리 부족
```bash
# 메모리 사용량 확인
docker stats

# 사용하지 않는 컨테이너/이미지 정리
docker system prune -a
```

#### 네트워크 문제
```bash
# Docker 네트워크 확인
docker network ls
docker network inspect be_pai

# 네트워크 재생성
docker-compose down
docker-compose up -d
```

### 서비스별 문제

#### Gateway 접속 불가
```bash
# Gateway 로그 확인
docker-compose logs gateway

# Gateway 재시작
docker-compose restart gateway

# 포트 확인
curl http://localhost:3006/health
```

#### 데이터베이스 연결 실패
```bash
# PostgreSQL 상태 확인
docker-compose logs postgres

# 연결 테스트
docker exec postgres pg_isready -U pai_user

# 데이터베이스 재시작
docker-compose restart postgres
```

#### AI 서비스 응답 없음
```bash
# AI 서비스 로그 확인
docker-compose logs ai-service

# AI 서비스 헬스 체크
curl http://localhost:8000/health

# 메모리 사용량 확인 (AI 서비스는 메모리 사용량이 높음)
docker stats ai-service
```

---

## 📱 모바일 앱 설정

### 개발 환경
```bash
# FE/.env 파일 생성
echo "API_BASE_URL=http://localhost:3006" > FE/.env
```

### 프로덕션 환경
```bash
# FE/.env 파일 수정
echo "API_BASE_URL=https://j13c101.p.ssafy.io" > FE/.env
```

### 앱 빌드
```bash
cd FE

# 개발 빌드
npx expo build:android
npx expo build:ios

# 프로덕션 빌드
npx expo build:android --release-channel production
npx expo build:ios --release-channel production
```

---

## 🔒 보안 설정

### SSL/TLS (프로덕션)
```yaml
# docker-compose.yml의 Traefik 설정
traefik:
  command:
    - '--certificatesresolvers.letsencrypt.acme.email=your-email@domain.com'
  labels:
    - 'traefik.http.routers.gateway.rule=Host(`your-domain.com`)'
```

### 환경 변수 보안
```bash
# 강력한 JWT 시크릿 생성
openssl rand -base64 32

# 강력한 데이터베이스 비밀번호 생성
openssl rand -base64 16
```

---

## 📈 성능 최적화

### 리소스 제한 설정
```yaml
# docker-compose.yml에 추가
services:
  user-service:
    mem_limit: 512m
    cpus: '0.5'

  ai-service:
    mem_limit: 2g
    cpus: '1.0'
```

### 캐시 설정
```bash
# Redis 메모리 최적화
echo "maxmemory 256mb" >> redis.conf
echo "maxmemory-policy allkeys-lru" >> redis.conf
```

---

## 📞 지원 및 문의

### 빠른 도움말
- **로그 확인**: `docker-compose logs -f`
- **상태 확인**: `docker-compose ps`
- **재시작**: `docker-compose restart`
- **정리**: `docker system prune`

### 추가 리소스
- [상세 포팅 매뉴얼](./포팅매뉴얼.md)
- [시연 시나리오](./시연시나리오.md)
- API 문서: http://localhost:3006/api/docs

### 긴급 지원
- GitHub Issues: 문제 신고
- 개발팀 이메일: dev@pai.com

---

**이 가이드를 따라하면 PAI 서비스를 빠르게 배포하고 실행할 수 있습니다. 추가적인 설정이나 문제 해결이 필요하면 상세 포팅 매뉴얼을 참조하세요.**